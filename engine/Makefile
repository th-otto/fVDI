#!make -f
#
# This software is licensed under the GNU General Public License.
# Please, see LICENSE.TXT for further information.
#

#
# gcc >= 2.95.3 (sparemint) version
#

TARGET = fvdi_gnu.prg

all: $(TARGET)

top_srcdir = ..
srcdir     = .

include $(top_srcdir)/CONFIGVARS

CFLAGS  = $(CPUOPTS) $(OPTS) $(WARNINGS) -I$(top_srcdir)/include -I$(top_srcdir)/modules/include

LDFLAGS += --mprg-flags=0x27

# FreeType2 things
ifneq ($(ft2_srcdir),)
 LIBS   := -lft2 $(LIBS)
 LDFLAGS += -L$(top_srcdir)/modules/ft2

 LIBFT2  = $(top_srcdir)/modules/ft2/libft2.a
 LIBFILES= $(LIBFT2)
 CFLAGS += $(FT2_CFLAGS)
endif


SINCSRC = \
	$(top_srcdir)/drivers/bitplane/1_expand.inc

SSRC = \
	fvdi.s \
	blit.s \
	colours.s \
	draw.s \
	expand.s \
	fill_sq.s \
	gnu.s \
	line_sq.s \
	mark_sq.s \
	mouse.s \
	simple.s \
	support.s \
	sys_call.s \
	textrndr.s \
	text.s \
	text_sq.s \
	traptabl.s \
	unimpl.s \
	vdi_misc.s \
	dcsdstub.s \
	bconstub.s \
	$(empty)


CSRC = \
	startup.c \
	utility.c \
	bezier.c \
	conic.c \
	escape.c \
	fonts.c \
	line.c \
	loader.c \
	math.c \
	patterns.c \
	polygon.c \
	setup.c \
	workstn.c \
	colour.c \
	textlib.c \
	calamus.c \
	bconout.c \
	default.c

CSRC += \
	$(top_srcdir)/modules/ft2/atari2b.c \
	$(top_srcdir)/modules/ft2/bics2u.c

# Handle DevPac -> gas conversions
# Defines SSRC_GNU and SINCSRC_GNU variables
include $(top_srcdir)/utility/conv2gas/RULES

SSRC_GNU_COMMON = \
	setjmp.gnu.s \
	$(empty)

SINCSRC_GNU += \
	$(top_srcdir)/include/types.inc \
	$(top_srcdir)/include/macros.gnu \
	$(top_srcdir)/include/vdi.gnu \
	$(top_srcdir)/include/linea.gnu \
	$(top_srcdir)/drivers/include/pixelmac.gnu

# Engine binary objects
ifeq ($(CPU),v4e)
OBJECTS = $(SSRC_GNU_CF:.s=.o) $(SSRC_GNU_COMMON:.s=.o)
else
OBJECTS = $(SSRC_GNU:.s=.o) $(SSRC_GNU_COMMON:.s=.o)
endif
OBJECTS += $(CSRC:.c=.o)

$(OBJECTS): $(SINCSRC_GNU)

$(LIBFT2):
	$(MAKE) -C $(top_srcdir)/modules/ft2

$(TARGET): $(OBJECTS) $(LIBFILES)
	echo $(CSRC)
	$(AM_V_LD)$(LD) -o $@ -Map=fvdi.map $(OBJECTS) $(LDFLAGS) $(LIBS)

$(top_srcdir)/include/types.inc: $(top_srcdir)/include/fvdi.h
	$(MAKE) -C $(top_srcdir)/utility/structer
	$(AM_V_GEN)( \
	  echo "*****"; \
	  echo "*"; \
	  echo "* fVDI structure declarations, by Johan Klockars"; \
	  echo "*"; \
	  echo "* GENERATED AUTOMATICALLY by structer from fvdi.h"; \
	  echo "* -- DO NOT EDIT --"; \
	  echo "*"; \
	  echo "* This is auto-generated by the Makefile from fvdi.h using"; \
	  echo "*  gcc -E -DANONYMOUS fvdi.h | structer Virtual=vwk Workstation=wk \\"; \
	  echo "*  Fontheader=font MFDB=mfdb Colour=colour RGB=rgb List=list \\"; \
	  echo "*  Driver=driver Mouse=mouse Device=dev DrvLine=drvline \\"; \
	  echo "*  DrvPalette=drvpalette > types.inc"; \
	  echo "*"; \
	  echo "* Most assembly files in the fVDI engine, as well as in its"; \
	  echo "* device drivers, need to include this file."; \
	  echo "*"; \
	  echo "* Since it would be difficult to do without this file when"; \
	  echo "* writing new device drivers, and to make it possible for"; \
	  echo "* some such drivers to be commercial, this file is put in"; \
	  echo "* the public domain. It is not copyrighted or under any sort"; \
	  echo "* of license."; \
	  echo "****"; \
	  echo ; \
	  $(CC) -E $< | \
	  $(top_srcdir)/utility/structer/structer \
	  Virtual=vwk Workstation=wk Fontheader=font MFDB=mfdb \
	  Colour=colour RGB=rgb List=list Driver=driver \
	  Mouse=mouse Device=dev DrvLine=drvline DrvPalette=drvpalette \
	  v_bez_pars=v_bez_pars; \
	 ) > $@.tmp && { mv $@.tmp $@; } || { $(RM) $@ $@.tmp; exit 1; }

include $(top_srcdir)/DEPENDENCIES

strip:
	$(STRIP) --strip-all $(TARGET)

clean:: clean_gnu
	$(RM) *.o $(TARGET) fvdi.map

install::
	mkdir -p $(DESTDIR)/auto
	cp -a $(TARGET) $(DESTDIR)/auto/fvdi.prg
